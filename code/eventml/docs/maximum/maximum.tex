% -*-LaTeX-*-

%%  Copyright (C) 2011 Vincent Rahli
%%  Permission is granted to copy, distribute and/or modify this document
%%  under the terms of the GNU Free Documentation License, Version 1.3
%%  or any later version published by the Free Software Foundation;
%%  with no Invariant Sections, no Front-Cover Texts, and no Back-Cover Texts.
%%  A copy of the license is included in the section entitled "GNU
%%  Free Documentation License".


\documentclass[final]{article}
%\documentclass[draft]{article}


%%%% PACKAGES

\usepackage{amsmath}
\usepackage{url}
\usepackage{float}
\usepackage{proof}
\usepackage{graphicx}
\usepackage{listings}
\usepackage{changepage}
\usepackage{makeidx}
\usepackage{fancyhdr}
\usepackage[nomargin,inline]{fixme}
\usepackage[usenames,dvipsnames]{color}
%\usepackage{hyperref}
\usepackage{{../../tex/bsymb}}
\usepackage{{../../tex/stmaryrd}}
\usepackage{{../../tex/nuprl}}
\usepackage{{../../tex/MSC}}

%%%% LISTING

\input{../../tex/eventml-listing}
\lstset{basicstyle=\small,language=EventML}

%% \definecolor{EMLgreen}{cmyk}{0.9,0.2,0.9,0.4}
%% \definecolor{EMLpurple}{cmyk}{0.1,0.9,0.14,0.29}
%% \definecolor{EMLpeach}{cmyk}{0,1,1,0.5}


%%%% INDEX

\makeindex


%%%% FIXME

\fxusetheme{color}
\fxuseenvlayout{color}


%%%% BIBLIOGRAPHY

%\bibliographystyle{alpha}


%%%% MACROS

\input{../../tex/macros}

\newenvironment{markb}
               {\color{red}}
%               {\color{black}}
               {}
\newenvironment{old}
               {\color{green}}
%               {\color{black}}
               {}
\newenvironment{rahli}
               {\color{blue}}
%               {\color{black}}
               {}
\newenvironment{david}
               {\color{purple}}
%               {\color{black}}
               {}

\newcommand{\dgEML}[1]{{\tt #1}}
\newcommand{\dgclassrel}[3]{\NUPRLclassrel{}{#1}{}{#2}{#3}}
   % NOTE: v \in X(e) is \dgclassrel{e}{X}{v}
\newcommand{\vXe}%
 {\ensuremath{\dgclassrel{\NUPRLevent}{\text{\lstinline{X}}}{\NUPRL{v}}}}
\newcommand{\vYe}
 {\ensuremath{\dgclassrel{\NUPRLevent}{\text{\lstinline{Y}}}{\NUPRL{v}}}}
\newcommand{\listinline}[1]{\text{\lstinline{#1}}}
\newcommand{\bsp}{\mbox{$\NUPRLpair{\NUPRL{b}}{\NUPRLpair{\NUPRL{s}}{\NUPRL{p}}}$}}

%%%% FIGURES

\floatstyle{ruled}
\restylefloat{figure}


%%%% TITLE

\title{Maximum}
\author{\prl\ team}


\changepage{1in}%textheight
           {1.5in}%textwidth
           {0in}%evensidemargin
           {-1in}%oddsidemargin
           {0in}%columnsep
           {0in}%topmargin
           {0in}%headheight
           {0in}%headsep
           {0in}%footskip


%%%% HEADER AND FOOTER

%\setlength{\headheight}{14.5pt}
\renewcommand\headrulewidth{0pt}
\pagestyle{fancy}
\lhead{}
\rhead{\today}

\begin{document}

\maketitle

\intitle{\lstinline{Memory}}


\begin{emlcode}
\begin{lstlisting}
class Accum-loc-class f init_state X =
  f o (X,Prior(self)?init_state) ;;

class Memory1 init tr X = Prior(Accum-loc-class tr init X)?init ;;
\end{lstlisting}
\end{emlcode}

\lstinline{Accum-loc-class} and \lstinline{Memory1} are state
machines.
%
\lstinline{Accum-loc-class} observes the current state of the state
machine at \lstinline{X}-events.
%
At every event, the \lstinline{Memory1} class observes the prior
state.

\intitle{\lstinline{Maximum}}

Let us define an instance of the \lstinline{Memory1} class, namely the
\lstinline{Maximum} class (see Fig.~\ref{fig:maximum}).  Let
\lstinline{int_obs'base} be an integer observer.  We define it as
follows:
\begin{emlcode}
\begin{lstlisting}
input int_obs : Int
\end{lstlisting}
\end{emlcode}
This declaration implicitly defines the \lstinline{int_obs'base} base
class, that observes integers in messages with headers
$\CONSatoms{int\_obs}$.

\begin{figure}[!h]
  \begin{center}
    \includegraphics[scale=0.35]{../images/maximum.eps}
  \end{center}
  \caption{The \lstinline{Maximum} class}
  \label{fig:maximum}
 \end{figure}

Assume that location \textbf{A} runs \lstinline{Maximum}.  Also,
assume that $\NUPRLevent_1$ is the first event occurring at
\textbf{A}.
\begin{itemize}
\item Event $\NUPRLevent_1$ corresponds to the receipt of a
  $\CONSatoms{int\_obs}$ message with data $3$.  At $\METAevent_1$,
  \lstinline{Maximum} observes $0$, which is \textbf{A}'s default
  state.
\item Event $\NUPRLevent_2$, corresponds to the receipt of a
  $\CONSatoms{int\_obs}$ message with data $2$.  At $\METAevent_2$,
  \lstinline{Maximum} observes $3$, which is \textbf{A}'s state
  computed as follows: take the maximum between the last
  $\CONSatoms{int\_obs}$ observation ($3$ in our example) and the
  state at that time ($0$ in our example).
\end{itemize}

\intitle{The computational and logical aspects of classes}

\begin{itemize}
\item Computational: In Fig.~\ref{fig:maximum}, at event
  $\NUPRLevent_4$, the process running a location \textbf{A} has
  aggregated information and given the input $12$ has computed the
  output $5$.
  %
  Here is a schematic version of the \lstinline{Maximum} state machine:
  \begin{center}
    \includegraphics[scale=0.3]{../images/maximum_sm.eps}
  \end{center}

\item Logical: In Fig.~\ref{fig:maximum}, at event $\NUPRLevent_4$,
  \lstinline{Maximum} observes $5$ because at the same location but at
  event $\NUPRLevent_3$, \lstinline{int_obs'base} observed $5$ and
  \lstinline{Maximum} observed $3$ (and \lstinline{(imax 5 3) = 5}).
\end{itemize}

\intitle{Computing using \lstinline{Maximum} state machine}

Let us now define two observers on top of \lstinline{Maximum} (see
\lstinline{Obs1} and \lstinline{obs2} defined in
Fig.~\ref{fig:maximum+obs}).

Our first observer, \lstinline{Obs1}, observers incoming integers when
the \lstinline{Maximum} state is between $4$ and $19$.  Therefore, at
events $\NUPRLevent_1$, $\NUPRLevent_2$, and $\NUPRLevent_3$,
\lstinline{Obs1} does not observe anything because the
\lstinline{Maximum} state is $0$ at $\NUPRLevent_1$ and $3$ at events
$\NUPRLevent_2$ and $\NUPRLevent_3$.  However, it observes $12$ at
event $\NUPRLevent_4$ because it receives a $\CONSatoms{int\_obs}$
message with data $12$ and its \lstinline{Maximum} state is $5$.  We
say that $\NUPRLevent_4$ is an \lstinline{Obs1}-event.

Our second observer built on top of \lstinline{Maximum},
\lstinline{Obs2}, observers pairs of (\lstinline{Maximum}
state/incoming integer) when the \lstinline{Maximum} state is between
$3$ and $19$.  Therefore, at events $\NUPRLevent_1$ and
$\NUPRLevent_2$, \lstinline{Obs2} does not observe anything because
the \lstinline{Maximum} state is $0$ at $\NUPRLevent_1$ and $3$ at
event $\NUPRLevent_2$.  However, it observes $(3,5)$ at event
$\NUPRLevent_3$ because its \lstinline{Maximum} state is $3$ and it
receives a $5$.  At event $\NUPRLevent_4$, \lstinline{Obs2} observes
$(5,12)$ because its \lstinline{Maximum} state is $5$ and it receives
a $\CONSatoms{int\_obs}$ message with data $12$.  We say that event
$\NUPRLevent_3$ and $\NUPRLevent_4$ are \lstinline{Obs2}-events.

Therefore, $\NUPRLevent_1$ and $\NUPRLevent_2$ are neither
\lstinline{Obs1}-events, nor \lstinline{Obs2}-events.  Event
$\NUPRLevent_2$ is an \lstinline{Obs1}-event but is not an
\lstinline{Obs2}-event.  And event $\NUPRLevent_3$ is both an
\lstinline{Obs1}- and an \lstinline{Obs2}-event.
%
All four events are \lstinline{int_obs'base}- and
\lstinline{Maximum}-events

\begin{figure}[!h]
  \begin{center}
    \includegraphics[scale=0.35]{../images/maximum_obs.eps}
  \end{center}
  \caption{The \lstinline{Maximum} class in combinations with 2 extra observers}
  \label{fig:maximum+obs}
\end{figure}


\intitle{\lstinline{Maximum} in parallel with an integer generator}

Let us now define a simple integer generator: \lstinline{Increment}
which we install at location \textbf{G} as depicted in
Fig.~\ref{fig:maximum+gen}.  The process running at location
\textbf{G}, implementing the class \lstinline{Increment}, generates
$\CONSatoms{int\_obs}$ messages which it sends to location \textbf{A}.
Note that if we do not impose FIFO, messages can be delivered in any
order.  In our example, the $\CONSatoms{int\_obs}$ message with data
$3$ is delivered to \textbf{A} before the one with data $2$.

\begin{figure}[!h]
  \begin{center}
    \includegraphics[scale=0.35]{../images/maximum_obs_react.eps}
  \end{center}
  \caption{The \lstinline{Maximum} class in parallel with an integer generator}
  \label{fig:maximum+gen}
\end{figure}

\intitle{\lstinline{Maximum} installed at two locations}

Let us now assume that \lstinline{Maximum} is running at two different
locations \textbf{A} and \textbf{B}.  Location \textbf{A} gets the
same inputs as before.  Location \textbf{B} receives
$\CONSatoms{int\_obs}$ messages with data $1$, $2$, $3$, and $6$.

Let us define a server \textbf{S}, which role it to request \textbf{A}
and \textbf{B} to send their \lstinline{Maximum} state.  Once
\textbf{S} has received the two numbers, it computes the maximum and
sends a success message to whichever machine sent the biggest number
and a failure message to the other one.

Let us first define the following interface:
\begin{emlcode}
\begin{lstlisting}
input start : Unit
internal request : Unit
internal max     : Unit
internal success : Unit
internal fail    : Unit
\end{lstlisting}
\end{emlcode}

The specification of \textbf{S}'s protocol is as follows:
\begin{emlcode}
\begin{lstlisting}
class Request = (\slf.\().request'broadcast {A,B} ()) o start'base;;

class Answer =
  let F slf (m1,l1) (m2,l2) =
    if m1 > m2
    then {success'send l1 (); fail'send l2 ()}
    else if m2 > m1
    then {success'send l2 (); fail'send l1 ()}
    else {}
  in F o (max'base,Prior(max'base));;

class Server = Request || Answer;;
\end{lstlisting}
\end{emlcode}

We also need \textbf{A} and \textbf{B} to be able to answer to
$\CONSatoms{request}$ messages:
\begin{emlcode}
\begin{lstlisting}
class ReplyToRequest =
  let F slf () max = {max'send S max}
  in F o (request'base,Maximum);;
\end{lstlisting}
\end{emlcode}

\textbf{A} and \textbf{B}'s protocols are then specified as follows:
\lstinline{Maximum || ReplyToRequest}.

\begin{figure}[!h]
  \begin{center}
    \includegraphics[scale=0.4]{../images/maximum_2loc.eps}
  \end{center}
  \caption{The \lstinline{Maximum} class in parallel with an integer generator}
  \label{fig:maximum+gen}
\end{figure}

Fig.~\ref{fig:max-event-ordering} depicts a simplified version of the
event ordering presented in Fig.~\ref{fig:maximum+gen}.  It also shows
that events \lstinline{a} and \lstinline{b} are, among other things,
\lstinline{ReplyToRequest}-events occurring at two different
locations.  Events \lstinline{s2} and \lstinline{s3} are
\lstinline{max'base}-events occurring at the same location.  Finally,
\lstinline{s3} is both a \lstinline{max'base}- and an
\lstinline{Answer}-event.

\begin{figure}[!h]
  \begin{center}
    \includegraphics[scale=0.5]{../images/maximum_2loc_sp.eps}
  \end{center}
  \caption{A simplified event ordering}
  \label{fig:max-event-ordering}
\end{figure}

\end{document}
